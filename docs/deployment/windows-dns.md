# Deployment: Windows DNS Server

Status: Draft

## Overview
Use Windows DNS Server (Active Directory-integrated or standalone) to override restricted domains to the redirect host.

## Approaches
1. Individual Primary Zones per Domain (manageable for small sets).
2. Single Wildcard-Friendly Strategy: Not directly supported; need explicit subdomain entries.
3. Hosts file at endpoint (not recommended centrally).
4. Import script to create A or CNAME records in a dedicated zone (e.g., `sb29guard.local`).

## Recommended Strategy
Create a forward lookup zone `sb29guard.local` hosting the redirect host (e.g., `blocked.sb29guard.local`). Then add individual zones for each restricted domain with an A record pointing to redirect IP.

## Prerequisites
- Windows Server 2019/2022 with DNS role.
- Administrative PowerShell.
- Redirect host IP (e.g., 10.10.10.50).
- Generated CSV/PowerShell script from `sb29guard generate-dns --format winps` (planned).

## PowerShell Zone Creation (Example)
```powershell
$domains = @(
  'exampletool.com',
  'trackingwidgets.io'
)
$redirectIP = '10.10.10.50'
foreach ($d in $domains) {
  if (-not (Get-DnsServerZone -Name $d -ErrorAction SilentlyContinue)) {
    Add-DnsServerPrimaryZone -Name $d -ZoneFile "$d.dns" -DynamicUpdate None
  }
  Add-DnsServerResourceRecordA -ZoneName $d -Name '@' -IPv4Address $redirectIP -TimeToLive 00:05:00 -AllowUpdateAny $false -CreatePtr $false -ErrorAction SilentlyContinue
}
```

## CNAME Consolidation Alternative
Create one zone per restricted domain with a root CNAME pointing to `blocked.sb29guard.local`.
```powershell
Add-DnsServerPrimaryZone -Name 'exampletool.com' -ZoneFile 'exampletool.com.dns' -DynamicUpdate None
Add-DnsServerResourceRecordCName -ZoneName 'exampletool.com' -HostNameAlias 'blocked.sb29guard.local' -Name '@'
```
Create `sb29guard.local` zone containing:
```powershell
Add-DnsServerPrimaryZone -Name 'sb29guard.local' -ZoneFile 'sb29guard.local.dns'
Add-DnsServerResourceRecordA -ZoneName 'sb29guard.local' -Name 'blocked' -IPv4Address '10.10.10.50'
```

## Wildcards
Windows DNS does not support wildcard at zone apex for multiple 3rd-party domains; must pre-expand (generator should produce explicit subdomains if required).

## Validation
```powershell
Resolve-DnsName exampletool.com
```
Expect A record with redirect IP.

## Automation
Use a scheduled task to run an updated script generated by the tool comparing existing zones & records (idempotent). Proposed command output (future):
```
sb29guard generate-dns --mode a-record --format winps --out dist/dns/import.ps1 --redirect-ipv4 10.10.10.50
```
Script includes detection & removal of obsolete domains.

## Logging
Windows DNS debug logging optional; rely primarily on web redirect service aggregate logs.

## Security Considerations
- Limit who can modify zones (RBAC / AD permissions).
- Backup DNS server configuration prior to bulk import.

## Rollback
Use previous zone file backups or AD object restore.
